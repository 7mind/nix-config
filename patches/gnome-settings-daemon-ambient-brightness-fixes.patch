From f34138e8d26f9ea128b2616333b20abfbcd705ce Mon Sep 17 00:00:00 2001
From: Sebastian Wick <sebastian.wick@redhat.com>
Date: Wed, 15 Oct 2025 19:40:19 +0200
Subject: [PATCH 1/6] power: Disable auto brightness when we release the light
 sensor

---
 plugins/power/gsd-power-manager.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/plugins/power/gsd-power-manager.c b/plugins/power/gsd-power-manager.c
index 490b5536d..6375b2b26 100644
--- a/plugins/power/gsd-power-manager.c
+++ b/plugins/power/gsd-power-manager.c
@@ -1314,16 +1314,17 @@ light_released_cb (GObject      *source_object,
                    GAsyncResult *res,
                    gpointer      user_data)
 {
+        GsdPowerManager *manager = GSD_POWER_MANAGER (user_data);
         g_autoptr(GError) error = NULL;
         g_autoptr(GVariant) result = NULL;
 
         result = g_dbus_proxy_call_finish (G_DBUS_PROXY (source_object),
                                            res,
                                            &error);
-        if (result == NULL) {
+        if (result == NULL)
                 g_warning ("Release of light sensors failed: %s", error->message);
-                return;
-        }
+
+        shell_brightness_set_auto_target (manager, -1.0);
 }
 
 static gboolean
-- 
GitLab


From eb6ee4f98031fbf438506e1abe374a3748d90869 Mon Sep 17 00:00:00 2001
From: Sebastian Wick <sebastian.wick@redhat.com>
Date: Wed, 15 Oct 2025 20:35:17 +0200
Subject: [PATCH 2/6] power: Take double in set_auto_target because we send a
 double

---
 plugins/power/gsd-power-manager.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/plugins/power/gsd-power-manager.c b/plugins/power/gsd-power-manager.c
index 6375b2b26..9aaaa5fff 100644
--- a/plugins/power/gsd-power-manager.c
+++ b/plugins/power/gsd-power-manager.c
@@ -1240,7 +1240,7 @@ shell_brightness_set_auto_target_cb (GObject      *source_object,
 
 static void
 shell_brightness_set_auto_target (GsdPowerManager *manager,
-                                  float            target)
+                                  double           target)
 {
         if (!manager->shell_brightness_proxy)
                 return;
-- 
GitLab


From 6492a7e4ee4da3c38bdf91809a1022bd5f04b274 Mon Sep 17 00:00:00 2001
From: Sebastian Wick <sebastian.wick@redhat.com>
Date: Wed, 15 Oct 2025 20:37:03 +0200
Subject: [PATCH 3/6] power: Use autoptrs in iio_proxy_changed

---
 plugins/power/gsd-power-manager.c | 13 +++++--------
 1 file changed, 5 insertions(+), 8 deletions(-)

diff --git a/plugins/power/gsd-power-manager.c b/plugins/power/gsd-power-manager.c
index 9aaaa5fff..0f725bd66 100644
--- a/plugins/power/gsd-power-manager.c
+++ b/plugins/power/gsd-power-manager.c
@@ -2922,8 +2922,8 @@ logind_proxy_signal_cb (GDBusProxy  *proxy,
 static void
 iio_proxy_changed (GsdPowerManager *manager)
 {
-        GVariant *val_has = NULL;
-        GVariant *val_als = NULL;
+        g_autoptr (GVariant) val_has = NULL;
+        g_autoptr (GVariant) val_als = NULL;
         gdouble brightness;
         gdouble alpha;
         gint64 current_time;
@@ -2940,10 +2940,10 @@ iio_proxy_changed (GsdPowerManager *manager)
         /* get latest results, which do not have to be Lux */
         val_has = g_dbus_proxy_get_cached_property (manager->iio_proxy, "HasAmbientLight");
         if (val_has == NULL || !g_variant_get_boolean (val_has))
-                goto out;
+                return;
         val_als = g_dbus_proxy_get_cached_property (manager->iio_proxy, "LightLevel");
         if (val_als == NULL || g_variant_get_double (val_als) == 0.0)
-                goto out;
+                return;
         manager->ambient_last_absolute = g_variant_get_double (val_als);
         g_debug ("Read last absolute light level: %f", manager->ambient_last_absolute);
 
@@ -2973,7 +2973,7 @@ iio_proxy_changed (GsdPowerManager *manager)
 
         /* no valid readings yet */
         if (manager->ambient_accumulator < 0.f)
-                goto out;
+                return;
 
         /* set new value */
         g_debug ("Setting brightness from ambient %.1f%%",
@@ -2984,9 +2984,6 @@ iio_proxy_changed (GsdPowerManager *manager)
 
         /* Assume setting worked. */
         manager->ambient_percentage_old = pc;
-out:
-        g_clear_pointer (&val_has, g_variant_unref);
-        g_clear_pointer (&val_als, g_variant_unref);
 }
 
 static void
-- 
GitLab


From 4f24cade467a876eb39c9e076779c5bf3af150e9 Mon Sep 17 00:00:00 2001
From: Sebastian Wick <sebastian.wick@redhat.com>
Date: Wed, 15 Oct 2025 20:41:22 +0200
Subject: [PATCH 4/6] power: Rename ambient_last_time to
 ambient_update_last_time

We will track another last_time later, so rename it in advance.
---
 plugins/power/gsd-power-manager.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/plugins/power/gsd-power-manager.c b/plugins/power/gsd-power-manager.c
index 0f725bd66..f5265c25f 100644
--- a/plugins/power/gsd-power-manager.c
+++ b/plugins/power/gsd-power-manager.c
@@ -170,7 +170,7 @@ struct _GsdPowerManager
         gdouble                  ambient_norm_value;
         gdouble                  ambient_percentage_old;
         gdouble                  ambient_last_absolute;
-        gint64                   ambient_last_time;
+        gint64                   ambient_update_last_time;
 
         /* Power Profiles */
         GDBusProxy              *power_profiles_proxy;
@@ -2957,11 +2957,11 @@ iio_proxy_changed (GsdPowerManager *manager)
 
         /* time-weighted constant for moving average */
         current_time = g_get_monotonic_time();
-        if (manager->ambient_last_time)
-                alpha = 1.0f / (1.0f + (GSD_AMBIENT_TIME_CONSTANT / (current_time - manager->ambient_last_time)));
+        if (manager->ambient_update_last_time)
+                alpha = 1.0f / (1.0f + (GSD_AMBIENT_TIME_CONSTANT / (current_time - manager->ambient_update_last_time)));
         else
                 alpha = 0.0f;
-        manager->ambient_last_time = current_time;
+        manager->ambient_update_last_time = current_time;
 
         /* calculate exponential weighted moving average */
         brightness = manager->ambient_last_absolute * 100.f / manager->ambient_norm_value;
@@ -3108,7 +3108,7 @@ gsd_power_manager_startup (GApplication *app)
         manager->ambient_norm_value = -1.f;
         manager->ambient_percentage_old = -1.f;
         manager->ambient_last_absolute = -1.f;
-        manager->ambient_last_time = 0;
+        manager->ambient_update_last_time = 0;
 
         /* Set up a delay inhibitor to be informed about suspend attempts */
         g_signal_connect (manager->logind_proxy, "g-signal",
-- 
GitLab


From 18e8f6832d456798eb35dbdcfda7bed22e1badb1 Mon Sep 17 00:00:00 2001
From: Sebastian Wick <sebastian.wick@redhat.com>
Date: Wed, 15 Oct 2025 20:43:45 +0200
Subject: [PATCH 5/6] power: Rework ambient light sensor normalization
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This reworks the normalization and fixes two things in particular:

The percentage `pc` is an int so if we want values different
from `0` and `1` we need to use floating point division.

When gsd-power controlled the backlight it would init that value from
the backlight on startup but we don't have that available anymore so
can only pick an arbitrary value.

Co-authored-by: Guido GÃ¼nther <agx@sigxcpu.org>
Fixes: 08ae6461 ("power: Switch from direct mutter backlight handling to Shell.Brightness")
---
 plugins/power/gsd-power-manager.c | 52 +++++++++++--------------------
 1 file changed, 19 insertions(+), 33 deletions(-)

diff --git a/plugins/power/gsd-power-manager.c b/plugins/power/gsd-power-manager.c
index f5265c25f..21d0bc0b0 100644
--- a/plugins/power/gsd-power-manager.c
+++ b/plugins/power/gsd-power-manager.c
@@ -90,6 +90,10 @@
 /* Convert bandwidth to time constant.  Units of constant are microseconds. */
 #define GSD_AMBIENT_TIME_CONSTANT       (G_USEC_PER_SEC * 1.0f / (2.0f * G_PI * GSD_AMBIENT_BANDWIDTH_HZ))
 
+/* Normalize against this factor of the current absolute reading.
+ * The value has been chosen arbitrarily but seems to work in practice. */
+#define GSD_AMBIENT_NORMALIZE_CONSTANT (1.5f)
+
 static const gchar introspection_xml[] =
 "<node>"
 "  <interface name='org.gnome.SettingsDaemon.Power.Keyboard'>"
@@ -168,8 +172,6 @@ struct _GsdPowerManager
         gboolean                 ambient_norm_required;
         gdouble                  ambient_accumulator;
         gdouble                  ambient_norm_value;
-        gdouble                  ambient_percentage_old;
-        gdouble                  ambient_last_absolute;
         gint64                   ambient_update_last_time;
 
         /* Power Profiles */
@@ -2647,19 +2649,6 @@ idle_became_active_cb (GnomeIdleMonitor *monitor,
         manager->user_active_id = 0;
 }
 
-static void
-ch_backlight_renormalize (GsdPowerManager *manager)
-{
-        if (manager->ambient_percentage_old < 0)
-                return;
-        if (manager->ambient_last_absolute < 0)
-                return;
-        manager->ambient_norm_value = manager->ambient_last_absolute /
-                                        (gdouble) manager->ambient_percentage_old;
-        manager->ambient_norm_value *= 100.f;
-        manager->ambient_norm_required = FALSE;
-}
-
 static void
 engine_settings_key_changed_cb (GSettings *settings,
                                 const gchar *key,
@@ -2924,10 +2913,10 @@ iio_proxy_changed (GsdPowerManager *manager)
 {
         g_autoptr (GVariant) val_has = NULL;
         g_autoptr (GVariant) val_als = NULL;
+        gdouble ambient_last_absolute;
         gdouble brightness;
         gdouble alpha;
         gint64 current_time;
-        gint pc;
 
         /* no display hardware */
         if (!shell_brightness_has_control (manager))
@@ -2942,17 +2931,20 @@ iio_proxy_changed (GsdPowerManager *manager)
         if (val_has == NULL || !g_variant_get_boolean (val_has))
                 return;
         val_als = g_dbus_proxy_get_cached_property (manager->iio_proxy, "LightLevel");
-        if (val_als == NULL || g_variant_get_double (val_als) == 0.0)
+        if (val_als == NULL || g_variant_get_double (val_als) <= 0.f)
                 return;
-        manager->ambient_last_absolute = g_variant_get_double (val_als);
-        g_debug ("Read last absolute light level: %f", manager->ambient_last_absolute);
+        ambient_last_absolute = g_variant_get_double (val_als);
+        g_debug ("Read absolute light level: %f", ambient_last_absolute);
 
         /* the user has asked to renormalize */
         if (manager->ambient_norm_required) {
-                g_debug ("Renormalizing light level from old light percentage: %.1f%%",
-                         manager->ambient_percentage_old);
-                manager->ambient_accumulator = manager->ambient_percentage_old;
-                ch_backlight_renormalize (manager);
+                g_debug ("Normalizing light level");
+
+                manager->ambient_norm_value = ambient_last_absolute * GSD_AMBIENT_NORMALIZE_CONSTANT;
+                if (manager->ambient_accumulator <= 0.f)
+                        manager->ambient_accumulator = 100.f / GSD_AMBIENT_NORMALIZE_CONSTANT;
+
+                manager->ambient_norm_required = FALSE;
         }
 
         /* time-weighted constant for moving average */
@@ -2964,7 +2956,7 @@ iio_proxy_changed (GsdPowerManager *manager)
         manager->ambient_update_last_time = current_time;
 
         /* calculate exponential weighted moving average */
-        brightness = manager->ambient_last_absolute * 100.f / manager->ambient_norm_value;
+        brightness = ambient_last_absolute * 100.f / manager->ambient_norm_value;
         brightness = MIN (brightness, 100.f);
         brightness = MAX (brightness, 0.f);
 
@@ -2975,15 +2967,11 @@ iio_proxy_changed (GsdPowerManager *manager)
         if (manager->ambient_accumulator < 0.f)
                 return;
 
-        /* set new value */
-        g_debug ("Setting brightness from ambient %.1f%%",
+        g_debug ("Calculated new target brightness from ambient: %.1f%%",
                  manager->ambient_accumulator);
-        pc = manager->ambient_accumulator;
-
-        shell_brightness_set_auto_target (manager, pc / 100);
-
-        /* Assume setting worked. */
-        manager->ambient_percentage_old = pc;
+        
+        shell_brightness_set_auto_target (manager,
+                                          manager->ambient_accumulator / 100.0);
 }
 
 static void
@@ -3106,8 +3094,6 @@ gsd_power_manager_startup (GApplication *app)
         manager->ambient_norm_required = TRUE;
         manager->ambient_accumulator = -1.f;
         manager->ambient_norm_value = -1.f;
-        manager->ambient_percentage_old = -1.f;
-        manager->ambient_last_absolute = -1.f;
         manager->ambient_update_last_time = 0;
 
         /* Set up a delay inhibitor to be informed about suspend attempts */
-- 
GitLab


