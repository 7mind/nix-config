#!/usr/bin/env bash

set -e

# Host configurations: "platform owner fqn"
# fqn="!" means use hostname as-is (local)
declare -A known_hosts
known_hosts["pavel-am5"]="linux pavel !"
known_hosts["pavel-fw"]="linux pavel !"
known_hosts["pavel-mba-m3"]="darwin pavel !"
known_hosts["o1"]="linux infra o1.7mind.io"
known_hosts["o2"]="linux infra o2.7mind.io"
known_hosts["nas"]="linux infra nas.home.7mind.io"
known_hosts["vm"]="linux infra vm.home.7mind.io"
known_hosts["testbench"]="linux infra testbench.home.7mind.io"

# Master identity pubkeys for each owner (used for rekeying)
declare -A owner_identities
owner_identities["pavel"]="age1ax4x0pwe00clawkp5zn7qdf5e2tvuu0echvachd0pv5hm8hq9qnswqpzek"
owner_identities["infra"]="age1ax4x0pwe00clawkp5zn7qdf5e2tvuu0echvachd0pv5hm8hq9qnswqpzek"

THISHOST="$(hostname -s)"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOTS=/nix/var/nix/gcroots/my-builds

# Options
HOSTS=()
DO_REFRESH=false
DO_SWITCH=false
DO_REKEY=false
DO_GIT=true
DO_LIST=false
MESSAGE=""
VERBOSE=false

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [HOST...]

Build and deploy NixOS/nix-darwin configurations.

If no HOST is specified, builds the current host (${THISHOST}).

Options:
  -s, --switch      Switch to the new configuration after building
  -k, --rekey       Rekey age secrets for the specified hosts before building
  -r, --refresh     Update flake inputs before building
  -n, --no-git      Skip git commit and push
  -m, --message=MSG Custom git commit message (default: "autosave (<host> / <os>)")
  -l, --list        List known hosts and exit
  -v, --verbose     Enable verbose output (set -x)
  -h, --help        Show this help message

Examples:
  $(basename "$0")                  # Build current host
  $(basename "$0") -s               # Build and switch current host
  $(basename "$0") -k -s            # Rekey, build, and switch current host
  $(basename "$0") o1 o2            # Build o1 and o2
  $(basename "$0") -k o1 o2         # Rekey and build o1 and o2
  $(basename "$0") -r -s            # Update flake, build, and switch
  $(basename "$0") -n               # Build without git operations

Known hosts:
EOF
    for host in "${!known_hosts[@]}"; do
        IFS=' ' read -r platform owner fqn <<< "${known_hosts[$host]}"
        printf "  %-16s %s (%s)\n" "$host" "$platform" "$owner"
    done | sort
    exit 0
}

list_hosts() {
    echo "Known hosts:"
    for host in "${!known_hosts[@]}"; do
        IFS=' ' read -r platform owner fqn <<< "${known_hosts[$host]}"
        printf "  %-16s %-8s %-8s %s\n" "$host" "$platform" "$owner" "$fqn"
    done | sort
    exit 0
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -s|--switch)
                DO_SWITCH=true
                shift
                ;;
            -k|--rekey)
                DO_REKEY=true
                shift
                ;;
            -r|--refresh)
                DO_REFRESH=true
                shift
                ;;
            -n|--no-git)
                DO_GIT=false
                shift
                ;;
            -m|--message)
                MESSAGE="$2"
                shift 2
                ;;
            --message=*)
                MESSAGE="${1#*=}"
                shift
                ;;
            -m=*)
                MESSAGE="${1#*=}"
                shift
                ;;
            -l|--list)
                DO_LIST=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            -*)
                echo "Error: Unknown option: $1" >&2
                echo "Use --help for usage information." >&2
                exit 1
                ;;
            *)
                HOSTS+=("$1")
                shift
                ;;
        esac
    done

    # Default to current host if none specified
    if [[ ${#HOSTS[@]} -eq 0 ]]; then
        HOSTS=("$THISHOST")
    fi

    # Default commit message
    if [[ -z "$MESSAGE" ]]; then
        MESSAGE="autosave ($(hostname) / $(uname))"
    fi
}

validate_hosts() {
    for host in "${HOSTS[@]}"; do
        if [[ -z "${known_hosts[$host]}" ]]; then
            echo "Error: Unknown host '$host'" >&2
            echo "Use --list to see known hosts." >&2
            exit 1
        fi
    done
}

add_all() {
    git add .
    git submodule foreach git add .
}

commit_and_push() {
    if [[ "$DO_GIT" == "true" ]]; then
        git submodule foreach "git diff-index --quiet HEAD || (git add -A && git commit -m \"${MESSAGE}\")"
        git diff-index --quiet HEAD || (git add -A && git commit -m "${MESSAGE}")
        git push --recurse-submodules=on-demand
    fi
}

do_refresh() {
    if [[ "$DO_REFRESH" == "true" ]]; then
        echo "==> Updating flake inputs..."
        nix flake update
    fi
}

do_rekey() {
    if [[ "$DO_REKEY" == "true" ]]; then
        echo "==> Rekeying secrets for: ${HOSTS[*]}"
        add_all
        local system
        system="$(uname -m)-$(uname -s | tr '[:upper:]' '[:lower:]')"

        for host in "${HOSTS[@]}"; do
            IFS=' ' read -r _ owner _ <<< "${known_hosts[$host]}"

            local identity="${owner_identities[$owner]}"
            if [[ -z "$identity" ]]; then
                echo "Warning: No identity configured for owner '$owner', skipping rekey for $host"
                continue
            fi

            echo "    Rekeying $host (owner: $owner)..."
            export AGENIX_REKEY_PRIMARY_IDENTITY="$identity"
            export AGENIX_REKEY_PRIMARY_IDENTITY_ONLY=true
            nix run ".?submodules=1#agenix-rekey-hosts.${host}.${system}.rekey"
        done
    fi
}

do_build() {
    echo "==> Building: ${HOSTS[*]}"
    add_all
    mkdir -p "$ROOTS"

    for host in "${HOSTS[@]}"; do
        IFS=' ' read -r platform _ _ <<< "${known_hosts[$host]}"

        echo "    Building $host ($platform)..."
        case "$platform" in
            darwin)
                nix build ".?submodules=1#darwinConfigurations.${host}.system" \
                    --out-link "${ROOTS}/${host}"
                ;;
            linux)
                nix build ".?submodules=1#nixosConfigurations.${host}.config.system.build.toplevel" \
                    --out-link "${ROOTS}/${host}"
                ;;
            *)
                echo "Error: Unknown platform '$platform' for host '$host'" >&2
                exit 1
                ;;
        esac
    done

    commit_and_push
}

do_switch() {
    if [[ "$DO_SWITCH" == "true" ]]; then
        echo "==> Switching: ${HOSTS[*]}"
        add_all

        for host in "${HOSTS[@]}"; do
            IFS=' ' read -r platform _ fqn <<< "${known_hosts[$host]}"
            local closure
            closure=$(readlink -f "${ROOTS}/${host}")

            # Use hostname if fqn is "!"
            [[ "$fqn" == "!" ]] && fqn="$host"

            echo "    Switching $host..."
            case "$platform" in
                darwin)
                    if [[ "$THISHOST" == "$host" ]]; then
                        "${closure}/sw/bin/darwin-rebuild" switch --flake .
                    else
                        nix copy --to "ssh://${fqn}" "${ROOTS}/${host}"
                        ssh -t "${fqn}" sudo -H --preserve-env=PATH env nix-env -p /nix/var/nix/profiles/system --set "$closure"
                        ssh -t "${fqn}" "sudo ${closure}/sw/bin/darwin-rebuild" activate
                    fi
                    ;;
                linux)
                    if [[ "$THISHOST" == "$host" ]]; then
                        sudo nix-env -p /nix/var/nix/profiles/system --set "$closure"
                        sudo /nix/var/nix/profiles/system/bin/switch-to-configuration switch
                    else
                        nix copy --to "ssh://root@${fqn}" "${ROOTS}/${host}"
                        ssh "root@$fqn" nix-env -p /nix/var/nix/profiles/system --set "$closure"
                        ssh "root@$fqn" /nix/var/nix/profiles/system/bin/switch-to-configuration switch
                    fi
                    ;;
            esac
        done

        commit_and_push
    fi
}

main() {
    parse_args "$@"

    if [[ "$DO_LIST" == "true" ]]; then
        list_hosts
    fi

    if [[ "$VERBOSE" == "true" ]]; then
        set -x
    fi

    validate_hosts
    cd "$SCRIPT_DIR"

    do_refresh
    do_rekey
    do_build
    do_switch

    echo "==> Done!"
}

main "$@"
